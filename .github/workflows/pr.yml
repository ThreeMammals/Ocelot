# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net
name: PR
on: pull_request

jobs:
  build-linux:
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      # https://github.com/actions/setup-dotnet/blob/main/README.md#environment-variables
      DOTNET_INSTALL_DIR: "/usr/share/dotnet" # don't override by /usr/lib/dotnet 
    steps:
    - name: .NET Info
      run: |
        dotnet --version
        echo ------------------------
        dotnet --info
    - name: Check .NET 8
      id: check-dotnet8
      run: |
        DOTNET8_INFO=$(dotnet --info)
        echo "Checking for .NET 8 SDK in dotnet info output..."
        echo "-----------------------------------------------"
        # Print matching lines
        echo "$DOTNET8_INFO" | grep -E '^\s*8\.0\.[0-9]+\s+\[/usr/share/dotnet/sdk\]'
        # Set environment variable based on match
        if echo "$DOTNET8_INFO" | grep -qE '^\s*8\.0\.[0-9]+\s+\[/usr/share/dotnet/sdk\]'; then
          echo "dotnet8_installed=true" >> $GITHUB_ENV
        else
          echo "dotnet8_installed=false" >> $GITHUB_ENV
        fi
    - name: Setup .NET 8
      if: env.dotnet8_installed == 'false'
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 8.0.x
    - name: .NET Info
      run: dotnet --info
    - name: Checkout
      uses: actions/checkout@v4
    - name: Add threemammals.com DNS-record
      run: |
        hosts='/etc/hosts'
        echo Content of $hosts
        echo ------------------------
        cat $hosts
        sudo sed -i '$a 127.0.0.1 threemammals.com' $hosts
        echo New content of $hosts
        echo ------------------------
        cat $hosts
        echo ------------------------
        ping -c 1 threemammals.com
    - name: Install mycert2.crt certificate
      run: |
        crt='./test/Ocelot.AcceptanceTests/mycert2.crt'
        if [ -f "$crt" ]; then
          echo mycert2.crt file found
        fi
        openssl version
        echo Moving the certificate to the trusted CA store...
        cert='/usr/local/share/ca-certificates/mycert2.crt'
        sudo cp $crt $cert # Copy the certificate to the system's trusted CA directory
        echo Updating the trusted certificates...
        sudo update-ca-certificates # This will add mycert.crt to the trusted root storage
        echo Verifying installation by listing in /etc/ssl/certs/ folder...
        sudo ls /etc/ssl/certs/ | grep mycert
        echo Verifying installation by openssl for $cert file...
        sudo chmod 644 $cert # adjusting the permissions
        ls -l $cert # verify ownership
        openssl x509 -in $cert -text -noout
        echo Installation is DONE
    - name: Restore
      run: dotnet restore ./Ocelot.sln -p:TargetFramework=net8.0
    - name: Build
      run: dotnet build --no-restore ./Ocelot.sln --framework net8.0
    - name: Unit Tests
      run: dotnet test --no-restore --no-build --verbosity normal --framework net8.0 ./test/Ocelot.UnitTests/Ocelot.UnitTests.csproj
    - name: Acceptance Tests
      run: dotnet test --no-restore --no-build --verbosity normal --framework net8.0 ./test/Ocelot.AcceptanceTests/Ocelot.AcceptanceTests.csproj

  build-macos:
    runs-on: macos-latest
    continue-on-error: true
    steps:
      - name: Setup .NET 9
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 9.0.x
      - name: .NET Info
        run: dotnet --info
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make script executable
        run: chmod +x .github/sh/add-dns-records.macos.sh
      - name: Add DNS-records
        run: ./.github/sh/add-dns-records.macos.sh

      - name: Additional Loopback IPs
        run: |
          echo Add multiple aliases in a loop
          for i in {2..255}; do
            sudo ifconfig lo0 alias 127.0.0.$i up
          done

          echo Test Loopback IPs
          for i in {2..255}; do
            echo ping 127.0.0.$i ...
            ping -c 1 127.0.0.$i
          done
  
      - name: Install certificate
        run: |
          # Install mycert2.crt certificate
          crt='./test/Ocelot.AcceptanceTests/mycert2.crt'
          openssl version
          echo Moving the certificate to the trusted CA store...
          if [ ! -f "$crt" ]; then
            echo "Certificate file not found: $crt"
            exit 1
          fi
          cert_root="/Library/Keychains/System.keychain"
          sudo security add-trusted-cert -d -r trustRoot -k "$cert_root" "$crt"
          echo Certificate added to trusted keychain.

          echo Verifying installation by listing certificates in $cert_root ...
          sudo security find-certificate -a -c "threemammals" -p "$cert_root"

          echo Verifying installation by openssl for $crt in $cert_root ...
          # Export the matching certificate(s) in PEM directly (security find-certificate -p)
          tmpcert=$(mktemp /tmp/mycert.XXXXXX.pem)
          # Use sudo + tee so the redirected file is written with appropriate permissions
          sudo security find-certificate -a -c "threemammals" -p "$cert_root" | sudo tee "$tmpcert" >/dev/null
          if [ ! -s "$tmpcert" ]; then
            echo "Failed to export certificate to $tmpcert"
            rm -f "$tmpcert"
            exit 1
          fi
          chmod 644 "$tmpcert"
          openssl x509 -in "$tmpcert" -text -noout
          rm -f "$tmpcert"
          echo Installation is DONE
      - name: Restore
        run: dotnet restore ./Ocelot.sln -p:TargetFramework=net9.0
      - name: Build
        run: dotnet build --no-restore ./Ocelot.sln --framework net9.0
      - name: Unit Tests
        run: dotnet test --no-restore --no-build --verbosity minimal --framework net9.0 ./test/Ocelot.UnitTests/Ocelot.UnitTests.csproj
      - name: Acceptance Tests
        run: dotnet test --no-restore --no-build --verbosity minimal --framework net9.0 ./test/Ocelot.AcceptanceTests/Ocelot.AcceptanceTests.csproj

  build-windows:
    runs-on: windows-latest
    continue-on-error: true
    steps:
      - name: Setup .NET 9
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 9.0.x
      - name: .NET Info
        run: dotnet --info
      - name: Checkout
        uses: actions/checkout@v4
      - name: Add DNS-records & Install certificate
        run: |
          # Append entry to hosts file
          Add-Content -Path "$env:SystemRoot\System32\drivers\etc\hosts" -Value "127.0.0.1 threemammals.com"
          # Ping 3 times
          Test-Connection -ComputerName "threemammals.com" -Count 3
          # Install mycert2.crt certificate
          $crt = ".\test\Ocelot.AcceptanceTests\mycert2.crt"
          if (Test-Path $crt) {
              Write-Output "mycert2.crt file found"
          }
          openssl version
          Write-Output "Moving the certificate to the trusted CA store..."
          $crt = ".\test\Ocelot.AcceptanceTests\mycert2.crt"
          # Import-Certificate -FilePath $crt -CertStoreLocation Cert:\CurrentUser\Root
          # Import into the Local Machine Trusted Root Certification Authorities store
          Import-Certificate -FilePath $crt -CertStoreLocation Cert:\LocalMachine\Root

          Write-Output "Verifying installation by listing trusted root certificates..."
          # List certificates in the Trusted Root store and filter for 'mycert'
          Get-ChildItem -Path Cert:\LocalMachine\Root | Where-Object { $_.Subject -like "*threemammals*" }

          Write-Output "Verifying installation by openssl for $crt file..."
          $cert = Get-ChildItem Cert:\LocalMachine\Root | Where-Object { $_.Subject -like "*threemammals*" }
          $cert_file = "C:\temp\mycert2_installed.cer"
          Export-Certificate -Cert $cert -FilePath $cert_file
          if (Test-Path $cert_file) {
              Write-Output "$cert_file file found"
          }
          # Display certificate details using OpenSSL (if installed)
          openssl x509 -in $cert_file -text -noout
          Write-Output "Installation is DONE"
      - name: Restore
        run: dotnet restore ./Ocelot.sln -p:TargetFramework=net9.0
      - name: Build
        run: dotnet build --no-restore ./Ocelot.sln --framework net9.0
      - name: Unit Tests
        run: dotnet test --no-restore --no-build --verbosity minimal --framework net9.0 ./test/Ocelot.UnitTests/Ocelot.UnitTests.csproj
      - name: Acceptance Tests
        run: dotnet test --no-restore --no-build --verbosity minimal --framework net9.0 ./test/Ocelot.AcceptanceTests/Ocelot.AcceptanceTests.csproj

  build-success:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: ${{ always() }} # run even Linux / MacOS / Windows build fails
    steps:
      - name: Decide success
        run: |
          linux_result="${{ needs.build-linux.result }}"
          macos_result="${{ needs.build-macos.result }}"
          windows_result="${{ needs.build-windows.result }}"
          if [[ $linux_result == "success" || $macos_result == "success" || $windows_result == "success" ]]; then
            echo "At least one succeeded"
          else
            echo "All failed"
            exit 1
          fi
  build-cake:
    needs: [build-success] # [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    # environment: Pull-Request
    # env:
    #   COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
    steps:
    - name: .NET Info
      run: |
        dotnet --version
        echo ------------------------
        dotnet --info
    - name: Check .NET 9
      id: check-dotnet9
      run: |
        DOTNET9_INFO=$(dotnet --info)
        echo "Checking for .NET 9 SDK in dotnet info output..."
        echo "-----------------------------------------------"
        echo "$DOTNET9_INFO" | grep -E '^\s*9\.0\.[0-9]+\s+\[/usr/share/dotnet/sdk\]'
        if echo "$DOTNET9_INFO" | grep -qE '^\s*9\.0\.[0-9]+\s+\[/usr/share/dotnet/sdk\]'; then
          echo "dotnet9_installed=true" >> $GITHUB_ENV
        else
          echo "dotnet9_installed=false" >> $GITHUB_ENV
        fi
    - name: Setup .NET 9
      if: env.dotnet9_installed == 'false'
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 9.0.x
    - name: .NET Info
      run: dotnet --info
    - name: Branch Name
      run: echo "Branch name is ${{ github.ref_name }}"
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Add threemammals.com DNS-record
      run: |
        sudo sed -i '$a 127.0.0.1 threemammals.com' /etc/hosts
        ping -c 1 threemammals.com
    - name: Install mycert.pfx certificate
      run: |
        crt='./test/Ocelot.AcceptanceTests/mycert2.crt'
        if [ -f "$crt" ]; then
          echo mycert2.crt file found
        fi
        openssl version
        echo Moving the certificate to the trusted CA store...
        cert='/usr/local/share/ca-certificates/mycert2.crt'
        sudo cp $crt $cert # Copy the certificate to the system's trusted CA directory
        echo Updating the trusted certificates...
        sudo update-ca-certificates # This will add mycert.crt to the trusted root storage
        echo Verifying installation by listing in /etc/ssl/certs/ folder...
        sudo ls /etc/ssl/certs/ | grep mycert
        echo Verifying installation by openssl for $cert file...
        sudo chmod 644 $cert # adjusting the permissions
        ls -l $cert # verify ownership
        openssl x509 -in $cert -text -noout
        echo Installation is DONE
    - name: Cake Build
      uses: cake-build/cake-action@v3
      with:
        target: LatestFramework
    - name: Prepare Coveralls
      run: |
        echo "Listing environment variables:"
        env | sort
        echo ------------ Detect coverage file ------------ 
        coverage_1st_folder=$(ls -d /home/runner/work/Ocelot/Ocelot/artifacts/UnitTests/*/ | head -1)
        echo "Detected first folder : $coverage_1st_folder"
        coverage_file="${coverage_1st_folder%/}/coverage.cobertura.xml"
        echo "Detecting file $coverage_file ..."
        if [ -f "$coverage_file" ]; then
          echo "Coverage file exists."
          echo "COVERALLS_coverage_file_exists=true" >> $GITHUB_ENV
          echo "COVERALLS_coverage_file=$coverage_file" >> $GITHUB_ENV
        else
          echo "Coverage file DOES NOT exist!"
          echo "COVERALLS_coverage_file_exists=false" >> $GITHUB_ENV
        fi
    - name: Coveralls
      if: env.COVERALLS_coverage_file_exists == 'true'
      uses: coverallsapp/github-action@v2
      with:
        file: ${{ env.COVERALLS_coverage_file }}
